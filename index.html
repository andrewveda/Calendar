<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quest Calendar</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; background: #f0f0f0; }
  input, button { padding: 8px; margin: 5px; font-size: 16px; }
  table { border-collapse: collapse; margin: 20px auto; }
  td, th { width: 40px; height: 40px; border: 1px solid #ccc; text-align: center; vertical-align: middle; }
  .done { color: red; font-weight: bold; }
</style>
</head>
<body>
<h2>Enter Your Name</h2>
<input type="text" id="name" placeholder="Your Name">
<button onclick="loadCalendar()">Show Calendar</button>

<div id="userDetails"></div>
<div id="calendar"></div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSSY6GoSKJV0QtEE8eA4ALdmOEMwE_QiXuF5JAAEpLbP8bisUYKv_iPVXpOXHP6ytfOHf7wtoR-8mVG/pubhtml?gid=595015100&single=true"; // Replace with your published CSV URL
let sheetData = [];

// Robust CSV parser (handles commas inside quotes)
function parseCSV(text) {
  const lines = text.trim().split('\n');
  return lines.map(line => {
    const regex = /(?:\"([^\"]*)\")|([^,]+)/g;
    const row = [];
    let match;
    while (match = regex.exec(line)) {
      row.push((match[1] || match[2]).trim());
    }
    return row;
  });
}

// Clean hidden characters in all cells
function cleanSheetData(data) {
  return data.map(row => row.map(cell => cell.trim().replace(/[\u200B-\u200D\uFEFF]/g, '')));
}

// Fetch the sheet once
fetch(CSV_URL)
  .then(res => res.text())
  .then(text => {
    sheetData = cleanSheetData(parseCSV(text));
    console.log("Sheet loaded. Names:", sheetData.map(r => r[1]));
  })
  .catch(err => alert("Error loading sheet: " + err));

function normalize(str) {
  return str.toLowerCase().replace(/\s+/g,'').replace(/[\u200B-\u200D\uFEFF]/g,'');
}

function loadCalendar() {
  const nameInput = document.getElementById('name').value.trim();
  if (!nameInput) return alert('Enter your name!');

  const userRow = sheetData.find(row => normalize(row[1]) === normalize(nameInput));
  if (!userRow) return alert("User not found!");

  const user = {
    name: userRow[1].trim(),
    totalCorrect: userRow[3],
    totalWrong: userRow[4],
    quests: userRow[7] ? userRow[7].split(',').map(q => q.trim()) : [],
    challenges: userRow[8] ? userRow[8].split(',').map(c => c.trim()) : []
  };

  renderCalendar(user);
}

function renderCalendar(user) {
  document.getElementById('userDetails').innerHTML = `
    <h3>${user.name}'s Quest Stats</h3>
    <p>Total Correct: ${user.totalCorrect}, Total Wrong: ${user.totalWrong}</p>
    <p>Quests Completed: ${user.quests.join(", ")}</p>
  `;

  const today = new Date();
  const month = today.getMonth();
  const year = today.getFullYear();
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  let html = "<table><tr>";
  const daysOfWeek = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  daysOfWeek.forEach(d => html += `<th>${d}</th>`);
  html += "</tr><tr>";

  for (let i = 0; i < firstDay; i++) html += "<td></td>";

  for (let date = 1; date <= daysInMonth; date++) {
    const questName = `Quest ${date}`;
    const done = user.challenges.includes(questName);
    html += `<td class="${done ? 'done' : ''}">${date}${done ? 'ðŸ”¥' : ''}</td>`;
    if ((date + firstDay) % 7 === 0) html += "</tr><tr>";
  }

  html += "</tr></table>";
  document.getElementById('calendar').innerHTML = html;
}
</script>
</body>
</html>
